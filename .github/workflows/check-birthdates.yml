name: Birthdate check

on:
  pull_request_target:
    paths:
      - "data/birth-dates/*.txt"

concurrency: # Only one job per PR at a time
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true # cancel any in-progress runs when a new commit is pushed

permissions:
  contents: read

jobs:
  wait-and-run: # 
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI to pass on this commit
        uses: lewagon/wait-on-check-action@v1.3.3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: "Restrict changes to \"data/birth-dates/*.txt\""
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success

  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check out PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # no need for full history

      # Always use the BASE branch's trusted files:
      - name: Use base branch script and answer key
        run: |
          set -euo pipefail
          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          git fetch --no-tags --depth=1 origin "$BASE_SHA"
          git show "$BASE_SHA:.github/workflows/validate_birthdates.sh" > .github/workflows/validate_birthdates.sh
          git show "$BASE_SHA:.github/workflows/birthdates" > .github/workflows/birthdates
          chmod +x .github/workflows/validate_birthdates.sh

      - name: Validate changed files
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
        run: .github/workflows/validate_birthdates.sh
